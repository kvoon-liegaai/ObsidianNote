# 发布订阅模式
发布订阅模式的三个特征

- 需要一个中间的容器，用来存储可以被触发的东西（函数， 对象）
- 需要一个方法，可以往容器里传入东西（函数，对象）
- 需要一个方法，可以将容器中的东西取出来使用（函数调用，对象的方法调用）


Vue模型

![[../img/Pasted image 20220520155628.png]]

页面中的变更（diff）是以组件为单位

- 如果页面中只有一个组件（Vue）实例不会有性能的损失
- 如果页面中有个多个组件（多watcher的情况），第一次会有多个watcher会存入到全局watcher
	- 如果修改了局部的数据（例如其中一个组件的数据），表示只会对该组件进行 diff 算法 === 只会重新生成该组件的抽象语法树 === 只会访问该组件的 watcher === 再次往全局存储的只有该组件的 watcher

1. 读取时：将watcher存入全局容器时，被称为**依赖收集**
2. 修改时：将全局容器中的 watcher 取出执行，被称为**派发更新**


### watcher 与 Dep
- vue项目中包含有很多的组件，各个组件都是**自治**的
- 那么watcher就可能会有多个
- 每一个watcher用于描述一个**渲染行为**或**计算行为**
	- 子组件发生数据的更新，页面需要重新渲染（真正的Vue中是**局部**渲染）
	- 例如 vue 中推荐使用计算属性 代替复杂的 插值表达式
		- 计算属性是会伴随其使用的属性的变化而变化的
		- `name: ()=> this.firstName + this.lastName`
			- 计算属性 依赖于 属性 firstName 和 属性 lastName
			- 只要被依赖的属性发生变化，就会促使计算属性**重新计算**（watcher干的事情）


**我们在访问的时候 就会进行收集， 在修改的时候 就会进行更新， 那么收集什么就更新什么**

所谓的依赖收集**实际上就是在告诉当前的 watcher 什么属性被访问了**，那么在这个 watcher 计算的时候 或者 渲染页面的时候 就会 将这些收集到的属性进行更新。



如何将属性与当前 watcher 关联起来？

- 在全局准备一个 targetStack( watcher 栈 )
- 在 Watcher 调用 get 方法的时候，将当前 Watcher 放到全局， 在 get 执行结束的时候（之后），将这个全局的 watcher 移除。提供：pushTarget，popTarget 方法
- 如何将当前属性和 watcher 关联起来？在每一个属性中都有一个 Dep 对象。

我们在访问对象属性的时候（get），我们的渲染 watcher 就在全局当中

1. 将属性与 watcher 相关联，其实就是将当前渲染的 watcher 存储到属性相关的 Dep 中。
2. 同时，将 dep 也存储到 当前全局的 watcher 中。 （相互引用关系，双向链表）

我们的dep有一个方法，叫 notify()，用于派发更新。内部实现就是将 dep 中的 subs 取出来，依次调用 update 方法。